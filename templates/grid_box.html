{% macro change_bitz_choice(bitz_field) %}
    <script>
        let select_field_{{bitz_field.id.replace('-', '_')}} = document.getElementById("{{bitz_field.id}}")
        let choice_field_{{bitz_field.id.replace('-', '_')}} = document.getElementById("{{bitz_field.id.replace('-bitz_select', '-bitz_list')}}")
        builder = window.location.href.split('/')
        builder = builder[builder.length -1]


        select_field_{{bitz_field.id.replace('-', '_')}}.onchange = function () {
            selection = select_field_{{bitz_field.id.replace('-', '_')}}.value;

            fetch("/selectformbitz/bitz/" + selection + "/" + builder).then(function (response) {
                response.json().then(function (data) {
                    let optionHTML = '';
                    for (choice in data) {
                        optionHTML += '<option value="' + data[choice][0] + '">' + data[choice][1] + '</option>';
                    }
                    choice_field_{{bitz_field.id.replace('-', '_')}}.innerHTML = optionHTML
                })
            })

        }
    </script>

{% endmacro %}
{% macro display_block(field_dict, value='', type='text', size=20) %}
<button type="button" id="{{field_dict['select'].id}}-button" class="btn btn-toggle align-items-center rounded" data-toggle="collapse" data-target="#{{ field_dict['select'].id}}-collapse" aria-controls="{{ field_dict['select'].id}}-collapse" style="z-index:1;">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-caret-down-square-fill" viewBox="0 0 16 16">
  <path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2zm4 4a.5.5 0 0 0-.374.832l4 4.5a.5.5 0 0 0 .748 0l4-4.5A.5.5 0 0 0 12 6H4z"/>
</svg>   {{ field_dict['select'].label }}
</button>
{{ field_dict['select']() }}
    <div class="collapse" id="{{ field_dict['select'].id }}-collapse">
        <ul class="btn-toggle-nav list-unstyled fw-normal pb-1">
        {% for k, field in field_dict.items() %}
            <p class="bg-light" style="z-index:1;">
                {% if k == "list" %}
                    {{ field }}
                    <a id="{{field.id[:-5]}}_edit" target="_blank" href="/edit/{{field_dict.get('builder_name')}}/{{field.id[:-5]}}/{{field_dict['select'].default}}/{{field.default}}/">Edit</a>

                {% elif k == "rotate" %}
                    {{ field(type="range", oninput="this.nextElementSibling.value = this.value") }} <output>{{field.data}}</output>째 rotation
                {% elif k == "shake" %}
                    {{ field(type="range", oninput="this.nextElementSibling.value = this.value") }} <output>{{field.data}}</output>째 rotation
                {% elif k == "anklex" %}
                    {{ field(type="range", oninput="this.nextElementSibling.value = this.value") }} <output>{{field.data}}</output>째 ankleX
                {% elif k == "ankley" %}
                    {{ field(type="range", oninput="this.nextElementSibling.value = this.value") }} <output>{{field.data}}</output>째 ankleY
                {% elif k == "scale" %}
                    {{ field(type="range", oninput="this.nextElementSibling.value = this.value") }} <output>{{field.data}}</output>x scale
                {% elif k == "merge" %}
                    {{ field(type="range", oninput="this.nextElementSibling.value = this.value") }} <output>{{field.data}}</output>x merge
                {% elif k == "movex" %}
                    {{ field(type="range", oninput="this.nextElementSibling.value = this.value") }} <output>{{field.data}}</output>x moveX
                {% elif k == "movey" %}
                    {{ field(type="range", oninput="this.nextElementSibling.value = this.value") }} <output>{{field.data}}</output>x moveY
                {% elif k == "bitz" %}
                    <div id="{{field.id}}">
                        {% for bitz_form in field %}
                            {{ bitz_form.bitz_label }}
                            <p class="bg-light" style="z-index:1;">
                                {{ bitz_form.bitz_label.data }} {{ bitz_form.bitz_select }} {{ bitz_form.bitz_list }}
                                {{change_bitz_choice(bitz_form.bitz_select)}}
                            </p>
                        {% endfor %}
                     </div>
                {% endif %}
            </p>
        {% endfor %}
            </ul>
    </div>
{% endmacro %}
    <form method="post" id="builder">
        <div class="list-group list-group-flush overflow-auto h-100" style="position: absolute; z-index:1;">
            {% for row in grid %}
                <div class="list-group-item list-group-item-action bg-light">
                    {{ display_block(row) }}
                </div>
            {% endfor %}

        </div>

        <div style="display: block; left: 40%; bottom:5%; position: absolute; z-index:1;">
            <p>{{ submit }} {{ dl_zip }} {{ live_edit }}</p>
            <p>Download missing files ? {{ dl_missing }}</p>
        </div>
    </form>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

{% for row in grid %}
    <script>
        let link_edit_{{row['select'].id}} = document.getElementById("{{row['list'].id[:-5]}}_edit")
        let select_field_{{row['select'].id}} = document.getElementById("{{row['select'].id}}")
        let choice_field_{{row['select'].id}} = document.getElementById("{{row['list'].id}}")
        builder = window.location.href.split('/')
        builder = builder[builder.length -1]


        select_field_{{row['select'].id}}.onchange = function () {
            selection = select_field_{{row['select'].id}}.value;

            fetch("/selectform/{{ row['select'].id }}/" + selection + "/" + builder).then(function (response) {
                response.json().then(function (data) {
                    let optionHTML = '';
                    for (choice in data) {
                        optionHTML += '<option value="' + data[choice][0] + '">' + data[choice][1] + '</option>';
                    }
                    choice_field_{{row['select'].id}}.innerHTML = optionHTML
                    link_edit_{{row['select'].id}}.href = "/edit/" + builder + "/" + choice_field_{{row['select'].id}}.id.replace('_list', '') + '/' + select_field_{{row['select'].id}}.value + '/' + choice_field_{{row['select'].id}}.value + '/'

                    fetch("/selectformbitz/bitz/" + builder + "/" + "{{ row['select'].id.replace('_select', '') }}/" + selection + "/" + data[0][0]).then(function (response) {
                        response.text().then(function (form_data) {

                            document.getElementById("{{ row['select'].id.replace('_select', '') }}_bitz").innerHTML = form_data;
                            var parser = new DOMParser();
                            var doc = parser.parseFromString(form_data, "text/html");
                            var scripts_ = doc.getElementsByTagName('script')
                            for (let i = 0; i < scripts_.length; i++) {
                                eval(scripts_[i].innerHTML)
                            }
                        })
                    })
                })
            })
        }

        choice_field_{{row['select'].id}}.onchange = function () {
            link_edit_{{row['select'].id}}.href = "/edit/" + builder + "/" + choice_field_{{row['select'].id}}.id.replace('_list', '') + '/' + select_field_{{row['select'].id}}.value + '/' + choice_field_{{row['select'].id}}.value + '/'
        }

    </script>
    <script>
        button_{{ row['select'].id }} = window.document.getElementById("{{ row['select'].id }}-button")
        collapse_{{ row['select'].id }} = window.document.getElementById("{{ row['select'].id }}-collapse")
        button_{{ row['select'].id }}.onclick = function(){
            if (collapse_{{ row['select'].id }}.className == 'collapse') {
                localStorage["{{ row['select'].id }}-collapse"] = 'collapse show'
            } else {
                localStorage["{{ row['select'].id }}-collapse"] = 'collapse'
            }
        }
        collapse_{{ row['select'].id }}.className = localStorage["{{ row['select'].id }}-collapse"]
    </script>
{% endfor %}