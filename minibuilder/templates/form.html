{% macro add_marker_listener(field) %}
<script>
        let {{field.id.replace('-', '_')}} = document.getElementById("{{field.id}}")
        {{field.id.replace('-', '_')}}.onclick = function() {
            {{field.id.replace('-', '_')}}.value = ''
            window.current_marker = {{field.id.replace('-', '_')}}.id
    }
</script>
{% endmacro %}

 <div style="z-index: 2; top: 55%;  padding: 1%;position: absolute">
    <form id="bitzform" method="POST" action="{{ url_for("edit_file_bp.addbitz", **mesh_info)}}">

        <ul id="form_bitz">
        {% for field_item in form_bitz %}
            {% if field_item is iterable %}
                <ul id="{{field_item.name}}">
                {% for field in field_item %}
                    <li>{{field.label}} {{ field }} <span id="{{field_item.name}}" class="btn-add btn-success">Add</span></li>
                    {{add_marker_listener(field.marker)}}
                {% endfor %}
                </ul>
            {% else %}
                {% if field_item.name=="csrf_token" %}
                    {{ field_item() }}
                {% else %}
                    <li >{{field_item.label}} {{ field_item() }}</li>
                {% endif %}
            {% endif %}
            {% if field_item.errors %}
                <span class="error help-inline">{{ field_item.errors|join(', ') }}</span>
            {% endif %}
            {% if field_item.description %}
                <p class="help-block">{{ field_item.description|safe }}</p>
            {% endif %}
        {% endfor %}
        </ul>

        <button type="button" id="submit">Add Bitz(s)</button>
    </form>
     <div id="status" class="container"></div>
</div>


<script src="//code.jquery.com/jquery-2.0.3.min.js"></script>
<script src="//momentjs.com/downloads/moment.min.js"></script>

<script type="text/javascript">
    $(document).ready(function() {

        $('button#submit').bind('click', function(){
            $.ajax({
              type: 'POST',
              url: $("form#bitzform").attr("action"),
              data: $("form#bitzform").serialize(),
              success: function(response) { $('div#status').stop(true,true).show().text(Object.values(response)).fadeOut(10000); },
              error: function (request, status, error) { $('div#status').show().text("Data not saved: " + error) },
            });
        });

        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        // initialize add/remove buttons depending on the fields already
        // generated by server
        Object.values(document.querySelectorAll('ul#form_bitz ul')).forEach(function(node){
            $('ul#form_bitz').find('ul#'+ node.id +' li:not(:last) .btn-add')
                .removeClass('btn-add').addClass('btn-remove')
                .removeClass('btn-success').addClass('btn-danger')
                .html('Remove');
        });

        // code to dynamically add form fields
        $(document).on('click', '.btn-add', function(e)
        {
            e.preventDefault();

            var button_id = $(this).attr('id'),
                controlForm = $('ul#form_bitz'),
                currentEntry = $(this).parents('ul#'+ button_id + ' li:last'),
                newEntry = $(currentEntry.clone());

            // clear input field before adding to DOM
            newEntry.find('input').val('');

            // increment id, name attributes for WTForms to pick up the values
            newEntry.find('input').attr("id", function(i, origValue) {
                return origValue.replace(/(\d+)/g, function(a,b) {
                    return +b+1;
                });
            });

            newEntry.find('input').attr("name", function(i, origValue) {
                return origValue.replace(/(\d+)/g, function(a,b) {
                    return +b+1;
                });
            });

            // change labels as well for the sake of clarity
            newEntry.find('label').attr("for", function(i, origValue) {
                return origValue.replace(/(\d+)/g, function(a,b) {
                    return +b+1;
                });
            });

            // check if the label belongs to an embedded form
            // i.e., if it's parent is a <th>
            // if so, dont use the text from 'for' attr
            newEntry.find('label').text(function(i, oldText) {
                if ($(this).parent().prop("tagName") === "TH") {
                    return oldText;
                }

                else{
                    return capitalizeFirstLetter($(this).attr("for"));
                }
            });

            newEntry.appendTo($('ul#form_bitz ul#'+ button_id));

            controlForm.find('ul#'+ button_id +' li:not(:last) .btn-add')
                .removeClass('btn-add').addClass('btn-remove')
                .removeClass('btn-success').addClass('btn-danger')
                .html('Remove');

            let marker_tmp_id = newEntry.find('input').attr("id").replace('-name', '-marker')
            window[marker_tmp_id] = document.getElementById(marker_tmp_id)
            window[marker_tmp_id].onclick = function() {
                window[marker_tmp_id].value = ''
                window.current_marker = window[marker_tmp_id].id
            }
        }
        ).on('click', '.btn-remove', function(e)
        {
          var button_id = $(this).attr('id');
          $(this).parents('ul#'+ button_id +' li:first').remove();

          e.preventDefault();
          return false;
        });

    });

</script>
